;;;; -*- Mode: LISP; Syntax: Ansi-Common-Lisp; Base: 10; Package: CL-POSTGRES; -*-

(in-package :saslprep)

(defun string-mapped-to-nothing (str)
  "Reads a string and removes any character that should be mapped to nothing per RFC 3454 and RFC 4013."
  (let ((s1 (coerce str 'simple-vector))
        (lst nil))
    (loop for x across s1 counting x into y do
         (cond ((char-mapped-to-nothing-p x))
               ((characterp x)
                (push x lst))
               (t (return-from string-mapped-to-nothing))))
    (setf lst (nreverse lst))
    (format nil "窿祗舂┅ㄤ彐躅篝蜷铉磲痧邃麸箴徙篝颟⒁遽潴篝蜷铉犷泔铞弪趔犷汨狎徙翦麒殂箬秕熹忮磲痧邃麸箴徙痱移炒荡犷移窗背麸箴徙瀹戾è蟊ㄣ镥蜚篝箝眇戾鲥泗矧┅祜镳骘徙蝻篌蟊泔躅糸铉轭麸滹麒孱ㄣ栳颦磲痧邃麸箴徙瀛箦翩ㄡ蝈蟊ō暴＼羽徙濠┅ㄣ镥蜚蟊篝蜷铉┅ㄤ彐躅筢箪痱屦铒蝽犰辁篝镳糸镱犰ㄦ矧侯骐悌⒂汜铙篝蜷铉涉犷汨狎徙翦箬秕熹忮磲痧邃麸铒翳轭绗轸屐轫轭狒弩翳狒汨狎徙翦虍涉犷汨狎徙翦轶铒痱轭翎忪狍汩楝轸蝈趱蝾铋飚涉弼弪汨狎徙翦蝈磲轭轭徭翦屐轫轭狒轱铙轶痱轭翎忪狍汩楝轸蝈趱蝾翳痱轭翎忪瀛狍汩篝蜷铉麒孱篝蜷铉痱轭翎忪瀛狍汩榄篝颟蝈趱蝾骝镯筢箪痱屦铒蝽犰辁篝颟箦翩篝篝蜷铉磲痧邃麸铒翳轭篝颟箦翩篝篝蜷铉磲痧邃麸箴徙篝颟箦翩篝踽钡侯矧磲扉篝骘蝽┅戾è忾溟蝈泗轱钺飙汨邈铋飑祜镳骘徙蝻篌篝泔躅糸铉轭麸滹麒孱铒瞽狍汩榄泔铘蝻飙汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃铒瞽狍汩榄泔铘蝻汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱ㄡ筱殚泔铘蝻飙汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃狍汩榄泔铘蝻飙汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱痱轹狒瀛躞瀛汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃痱轹狒瀛躞瀛汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱铒瞽汨狎泔溴痫轭舡ㄢ徜汨狎弪蝻痱镨殁轸邃铒瞽汨狎泔溴痫轭汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱篚蝌镧狒瀛泔溴痫轭舡ㄢ徜汨狎弪蝻痱镨殁轸邃篚蝌镧狒瀛泔溴痫轭汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱ㄩ钺痧蝻痱獒翦骘颦痨衢瞽翦舡汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃轭狃痱镳蜷狒瀛骘颦痨衢瞽翦舡汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱ㄩ钺痧蝻痱獒翦骘颦汜铒铋汜飙蝈痱弩孱翎糸镱汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃轭狃痱镳蜷狒瀛骘颦汜铒铋汜飙蝈痱弩孱翎糸镱汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱ㄣ栳铉瀛溟箴灬痱镳弪豉汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃汨犷珏溟箴灬痱镳弪豉汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅麒孱翎珑轭绛汨狎ㄢ徜汨狎弪蝻痱镨殁轸邃翎珑轭汨狎徙翦轭篝蜷铉疱移窗背忽犰蹂┅ㄣ镱è犷铒忾溟蝈泗轱钺飙汨邈氅ㄣ栳颦鏖翳忾溟蝈泗轱钺飙痱镳弪豉噎矧撂┅箦翩忾溟蝈泗轱钺飙汨邈⒁┅è犷铒忾溟蝈泗轱钺飙汨邈氅ㄣ栳颦鏖翳忾溟蝈泗轱钺飙痱镳弪豉汰┅箦翩忾溟蝈泗轱钺飙汨邈⑻┅è犷ㄥ聃犰忾溟蝈泗轱钺飙汨邈⑻ㄣ栳颦鏖翳忾溟蝈泗轱钺飙痱镳弪豉噎矧撂┅ㄢ徜汨狎弪蝻⒚镱骒殂糸铉忾溟蝈泗轱钺汨狎徙翦蝮轭篝蜷铉忽犰蹂篝颟è犷ㄥ聃犰忾溟蝈泗轱钺飙汨邈⒁ㄣ栳颦鏖翳忾溟蝈泗轱钺飙痱镳弪豉汰┅ㄢ徜汨狎弪蝻⒚镱骒殂糸铉忾溟蝈泗轱钺汨狎徙翦蝮轭篝蜷铉忽犰蹂篝颟铋飑┅篝颟